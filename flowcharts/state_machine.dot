digraph StateMachine {
    // Graph styling
    graph [fontname="Arial", fontsize=16, nodesep=0.8, ranksep=1.0, splines=ortho];
    node [fontname="Arial", fontsize=12, shape=box, style="filled", fillcolor="#E0F4FF", color="#0078D7", penwidth=2.0];
    edge [fontname="Arial", fontsize=11, color="#666666", penwidth=1.2, arrowsize=0.9];

    // Title
    labelloc="t";
    label="ESP32-S3 Stage 1 State Machine";

    // State nodes with descriptive labels
    STARTUP [label="STARTUP\nInitial state, sets clamps", fillcolor="#D4F4FA", group=init];
    HOMING [label="HOMING\nCalibrates motors to home positions", fillcolor="#D4F4FA", group=init];
    READY [label="READY\nWaiting for cycle switch", fillcolor="#CCFFCC", fontsize=16, width=1.8, height=1.2, penwidth=3.0];
    RELOAD [label="RELOAD\nWaiting for reload switch off", fillcolor="#CCFFFF"];
    CUTTING [label="CUTTING\nExecuting cutting sequence", fillcolor="#FFFFCC"];
    YESWOOD [label="YESWOOD\nWood detected after cut", fillcolor="#E6FFE6"];
    NOWOOD [label="NOWOOD\nNo wood detected after cut", fillcolor="#E6E6FF"];
    ERROR [label="ERROR\nGeneral error state", fillcolor="#FFD2D2"];
    WOOD_SUCTION_ERROR [label="WOOD_SUCTION_ERROR\nWood suction failure", fillcolor="#FFCCCB"];
    CUT_MOTOR_HOME_ERROR [label="CUT_MOTOR_HOME_ERROR\nCut motor homing failure", fillcolor="#FFCCCB"];

    // Define initialization box
    subgraph cluster_init {
        label="One-Time Initialization";
        style="dashed";
        color="#888888";
        fontsize=14;
        bgcolor="#F9F9F9";
        STARTUP; HOMING;
    }

    // Transition edges
    STARTUP -> HOMING [xlabel="Immediate"];
    
    HOMING -> READY [xlabel="Homing complete"];
    HOMING -> ERROR [xlabel="Position motor error", color="#CC0000"];
    HOMING -> CUT_MOTOR_HOME_ERROR [xlabel="Cut motor error", color="#CC0000"];
    
    READY -> RELOAD [xlabel="Reload switch ON"];
    READY -> CUTTING [xlabel="Cycle switch ON &\nToggle not needed", color="#006600", penwidth=3.6];
    
    RELOAD -> READY [xlabel="Reload switch OFF"];
    
    CUTTING -> YESWOOD [xlabel="Wood detected", color="#006600", penwidth=3.6];
    CUTTING -> NOWOOD [xlabel="No wood detected", color="#FFCC00", penwidth=2.4];
    CUTTING -> WOOD_SUCTION_ERROR [xlabel="Suction failure", color="#CC0000"];
    
    YESWOOD -> READY [xlabel="Operation complete or\nreload requested"];
    YESWOOD -> CUTTING [xlabel="Continue cutting while\nwood is available", color="#006600", penwidth=3.6];
    YESWOOD -> CUT_MOTOR_HOME_ERROR [xlabel="Cut motor fails\nto home", color="#CC0000"];
    
    NOWOOD -> READY [xlabel="Return complete", color="#FFCC00", penwidth=2.4];
    
    ERROR -> HOMING [xlabel="Cycle toggle detected", color="#CC0000"];
    WOOD_SUCTION_ERROR -> HOMING [xlabel="Cycle toggle detected", color="#CC0000"];
    CUT_MOTOR_HOME_ERROR -> HOMING [xlabel="Successful recovery or\nCycle toggle", color="#CC0000"];

    // Formatting to improve layout
    { rank=same; READY RELOAD }
    { rank=same; YESWOOD NOWOOD }
    { rank=same; ERROR WOOD_SUCTION_ERROR CUT_MOTOR_HOME_ERROR }
} 